# Анализ функции F\_WORKS\_LIST и проблем производительности

## Цель анализа

Выявить проблемы производительности в функции `dbo.F_WORKS_LIST()` и связанных с ней объектах, а также определить потенциальные направления оптимизации без изменения структуры базы данных.

---

## Общее описание

Функция `dbo.F_WORKS_LIST()` возвращает список заказов из таблицы `Works` вместе с агрегированными данными из связанных таблиц (`WorkItem`, `Employee`, `WorkStatus`).

---

## Основные проблемы производительности

### 1. Использование скалярных UDF на каждую строку

Функция вызывает:

* `dbo.F_WORKITEMS_COUNT_BY_ID_WORK(Id_Work, 0)`
* `dbo.F_WORKITEMS_COUNT_BY_ID_WORK(Id_Work, 1)`
* `dbo.F_EMPLOYEE_FULLNAME(Id_Employee)`

Это плохо тем, что при возврате 3000 строк вызываются до 9000 дополнительных SELECT-запросов к таблицам `WorkItem` и `Employee`. Это типичный пример проблемы "N+1 запросов".

### 2. Сложные подзапросы в UDF

Функция `F_EMPLOYEE_FULLNAME()` вызывает `F_EMPLOYEE_GET()`, что добавляет дополнительный SELECT даже при наличии переданного `Id_Employee`.

### 3. Отсутствие фильтрации в выборке

Запрос возвращает `TOP 3000` записей, сортированных по `Id_Work DESC`, но без ограничения по дате, статусу или другим условиям. Это увеличивает объем обрабатываемых строк.

### 4. Потенциально неэффективные условия в подзапросах

```sql
AND id_analiz NOT IN (SELECT id_analiz FROM Analiz WHERE is_group = 1)
```

* Использование `NOT IN` может быть менее эффективно, чем `LEFT JOIN ... IS NULL`.
* Возможно отсутствие композитных индексов на `(id_work, is_complit)` в `WorkItem`.

### 5. Форматирование данных в SELECT

```sql
convert(varchar(10), works.CREATE_Date, 104) AS D_DATE
```

Строковые преобразования в `SELECT` увеличивают нагрузку при большом количестве строк. Не критично, но может повлиять при масштабировании.

---

## Вывод

Наиболее значимые проблемы:

* Скалярные функции внутри `SELECT` (главный источник замедления)
* Отсутствие предварительной агрегации и джойнов
* Использование `NOT IN` и потенциально неоптимальных индексов
